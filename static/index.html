<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Smart Scheduler</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0 auto; max-width: 800px; padding: 20px; background-color: #f9fafb; }
        .container { background-color: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); position: relative; }
        h1, h2 { color: #111827; }
        label { display: block; margin-top: 15px; font-weight: 600; color: #374151; }
        textarea, input[type="text"], input[type="date"] { width: 98%; padding: 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 1rem; margin-top: 5px; }
        .row { display: flex; gap: 10px; }
        .col { flex: 1; }
        button { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; margin-top: 20px; }
        .btn-secondary { background-color: #e5e7eb; color: #1f2937; }
        .btn-primary { background-color: #2563eb; color: white; font-weight: 600; }
        .btn-google { background-color: #DB4437; color: white; font-weight: bold; float: right; text-decoration: none; padding: 10px 15px; border-radius: 5px; font-size: 0.9rem; }
        hr { border: none; border-top: 1px solid #e5e7eb; margin: 25px 0; }
        .loading { display: none; text-align: center; margin-top: 10px;}
        #user-status { float: right; font-size: 0.9rem; margin-top: 10px; margin-right: 10px; }

        /* Updated AI Message Box Style */
        .ai-msg-box { background-color: #eff6ff; border: 1px solid #bfdbfe; color: #1e3a8a; padding: 15px; border-radius: 10px; margin-top: 10px; display: none; }
        .ai-header { font-weight: bold; font-size: 0.9rem; margin-bottom: 5px; display: block; }

        .lang-switch { position: absolute; top: 20px; left: 25px; font-size: 0.9rem; }
        .lang-btn { background: none; border: none; cursor: pointer; color: #666; font-weight: bold; padding: 0; }
        .lang-btn.active { color: #2563eb; text-decoration: underline; }
        .lang-divider { color: #ddd; margin: 0 5px; }

        .model-indicator { text-align: right; font-size: 0.75rem; color: #999; margin-top: 5px; font-style: italic; }
    </style>
</head>
<body>

    <div class="container">
        <div class="lang-switch">
            <button onclick="setLanguage('ko')" class="lang-btn" id="btn-ko">ÌïúÍµ≠Ïñ¥</button>
            <span class="lang-divider">|</span>
            <button onclick="setLanguage('en')" class="lang-btn active" id="btn-en">English</button>
        </div>

        <div id="login-area"><a href="/login" class="btn-google" id="txt-login">üìÖ Login with Google</a></div>
        <div id="user-status"></div>
        <div style="clear: both;"></div>

        <h1 id="txt-title" style="margin-top: 40px;">AI Smart Scheduler üìÖ</h1>
        <p id="txt-subtitle">Type a schedule. We use AI to extract details!</p>

        <h2>Step 1: Input</h2>
        <label id="lbl-input">üìù Input Text</label>
        <textarea id="input-text" rows="3" placeholder="Ex: 'Trip to Jeju from Nov 20 to 23'"></textarea>

        <div id="ai-message" class="ai-msg-box">
            <span class="ai-header">ü§ñ AI Assistant:</span>
            <span id="ai-text"></span>
            <div style="display:flex; gap:5px; margin-top:10px;">
                <input type="text" id="reply-input" style="flex:1; padding:5px;" placeholder="Type answer...">
                <button onclick="sendReply()" style="margin:0; padding:5px 10px; font-size:0.9rem;" class="btn-primary">Send</button>
            </div>
        </div>

        <button id="extract-button" class="btn-secondary" onclick="handleExtract()">1. Extract Info</button>
        <div id="model-indicator" class="model-indicator"></div>

        <hr>

        <h2>‚úèÔ∏è Step 2: Review</h2>
        <label id="lbl-title">üéâ Event Title</label> <input type="text" id="summary-box">

        <div class="row">
            <div class="col">
                <label id="lbl-start">üìÖ Start Date</label> <input type="text" id="start-date-box" placeholder="YYYY-MM-DD">
            </div>
            <div class="col">
                <label id="lbl-end">üìÖ End Date</label> <input type="text" id="end-date-box" placeholder="YYYY-MM-DD">
            </div>
        </div>

        <div class="row">
            <div class="col">
                <label id="lbl-time">‚è∞ Time (Optional)</label> <input type="text" id="time-box" placeholder="HH:MM">
            </div>
            <div class="col" style="display:flex; align-items:center; margin-top:35px;">
                <input type="checkbox" id="allday-check" style="width:auto; margin-right:5px;">
                <label for="allday-check" style="margin:0;" id="lbl-allday">All Day Event</label>
            </div>
        </div>

        <label id="lbl-loc">üìç Location</label> <input type="text" id="loc-box">

        <div style="margin-top: 20px; padding: 10px; background-color: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 5px;">
            <input type="checkbox" id="data-consent" checked style="width:auto;">
            <label for="data-consent" style="display:inline; font-weight:normal; color:#166534;" id="lbl-consent">
                (Optional) I agree to donate data for AI training.
            </label>
        </div>

        <button id="add-calendar-btn" class="btn-primary" onclick="handleAddToCalendar()">üìÖ Add to Google Calendar</button>
        <div class="loading" id="loading-spinner">üîÑ Processing...</div>
        <div id="result-output" style="margin-top: 20px; font-weight: bold;"></div>
    </div>

    <script>
        let isLoggedIn = false;
        let originalText = "";

        const translations = {
            ko: {
                title: "AI Ïä§ÎßàÌä∏ Ïä§ÏºÄÏ§ÑÎü¨ üìÖ",
                subtitle: "ÏùºÏ†ïÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî. AIÍ∞Ä ÏûêÎèôÏúºÎ°ú Ï†ïÎ¶¨Ìï¥Ï§çÎãàÎã§!",
                lblInput: "üìù ÏûÖÎ†• (ÌÖçÏä§Ìä∏)",
                placeholder: "Ïòà: '11Ïõî 20ÏùºÎ∂ÄÌÑ∞ 23ÏùºÍπåÏßÄ Ï†úÏ£ºÎèÑ Ïó¨Ìñâ'",
                btnExtract: "1. Ï†ïÎ≥¥ Ï∂îÏ∂úÌïòÍ∏∞",
                lblTitle: "üéâ ÏùºÏ†ï Ï†úÎ™©",
                lblStart: "üìÖ ÏãúÏûë ÎÇ†Ïßú",
                lblEnd: "üìÖ Ï¢ÖÎ£å ÎÇ†Ïßú",
                lblTime: "‚è∞ ÏãúÍ∞Ñ (ÏÑ†ÌÉù)",
                lblAllday: "Ï¢ÖÏùº ÏùºÏ†ï",
                lblLoc: "üìç Ïû•ÏÜå",
                lblConsent: "(ÏÑ†ÌÉù) AI ÌïôÏäµÏùÑ ÏúÑÌï¥ Îç∞Ïù¥ÌÑ∞ Í∏∞Î∂ÄÏóê ÎèôÏùòÌï©ÎãàÎã§.",
                btnAdd: "üìÖ Íµ¨Í∏Ä Ï∫òÎ¶∞ÎçîÏóê Îì±Î°ù",
                login: "üìÖ Íµ¨Í∏Ä Î°úÍ∑∏Ïù∏",
                processing: "üîÑ Ï≤òÎ¶¨ Ï§ë..."
            },
            en: {
                title: "AI Smart Scheduler üìÖ",
                subtitle: "Type a schedule. We use AI to extract details!",
                lblInput: "üìù Input Text",
                placeholder: "Ex: 'Trip to Jeju from Nov 20 to 23'",
                btnExtract: "1. Extract Info",
                lblTitle: "üéâ Event Title",
                lblStart: "üìÖ Start Date",
                lblEnd: "üìÖ End Date",
                lblTime: "‚è∞ Time (Optional)",
                lblAllday: "All Day Event",
                lblLoc: "üìç Location",
                lblConsent: "(Optional) I agree to donate data for AI training.",
                btnAdd: "üìÖ Add to Google Calendar",
                login: "üìÖ Login with Google",
                processing: "üîÑ Processing..."
            }
        };

        let currentLang = 'en';

        function setLanguage(lang) {
            currentLang = lang;
            const t = translations[lang];
            document.getElementById('txt-title').innerText = t.title;
            document.getElementById('txt-subtitle').innerText = t.subtitle;
            document.getElementById('lbl-input').innerText = t.lblInput;
            document.getElementById('input-text').placeholder = t.placeholder;
            document.getElementById('extract-button').innerText = t.btnExtract;
            document.getElementById('lbl-title').innerText = t.lblTitle;
            document.getElementById('lbl-start').innerText = t.lblStart;
            document.getElementById('lbl-end').innerText = t.lblEnd;
            document.getElementById('lbl-time').innerText = t.lblTime;
            document.getElementById('lbl-allday').innerText = t.lblAllday;
            document.getElementById('lbl-loc').innerText = t.lblLoc;
            document.getElementById('lbl-consent').innerText = t.lblConsent;
            document.getElementById('add-calendar-btn').innerText = t.btnAdd;
            document.getElementById('txt-login').innerText = t.login;

            document.getElementById('btn-ko').className = lang==='ko' ? 'lang-btn active' : 'lang-btn';
            document.getElementById('btn-en').className = lang==='en' ? 'lang-btn active' : 'lang-btn';
        }

        fetch('/user-info').then(r=>r.json()).then(d=>{
            if(d.user){
                isLoggedIn=true;
                document.getElementById('login-area').innerHTML=`<a href="/logout" class="btn-secondary" style="text-decoration:none">Logout</a>`;
                document.getElementById('user-status').innerText=`Welcome, ${d.user.name}`;
            }
        });

        async function handleExtract() {
            const text = document.getElementById('input-text').value;
            const btn = document.getElementById('extract-button');
            const aiMsg = document.getElementById('ai-message');
            const indicator = document.getElementById('model-indicator');

            btn.innerText = translations[currentLang].processing;
            btn.disabled = true; aiMsg.style.display = 'none'; indicator.innerText = "";

            try {
                const res = await fetch('/extract', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ text: text, lang: currentLang })
                });
                const data = await res.json();
                originalText = text;

                document.getElementById('summary-box').value = data.summary;
                document.getElementById('start-date-box').value = data.start_date;
                document.getElementById('end-date-box').value = data.end_date;
                document.getElementById('time-box').value = data.time;
                document.getElementById('loc-box').value = data.location;
                document.getElementById('allday-check').checked = data.is_allday;

                if (data.used_model) {
                    indicator.innerText = "‚öôÔ∏è Processed by: " + data.used_model;
                }

                if(data.ai_message) {
                    document.getElementById('ai-text').innerText = data.ai_message;
                    aiMsg.style.display = 'block';
                }
            } catch(e) { alert("Error: " + e); }
            finally { btn.innerText = translations[currentLang].btnExtract; btn.disabled = false; }
        }

        function sendReply() {
            const reply = document.getElementById('reply-input').value;
            if(!reply) return;
            document.getElementById('input-text').value += " " + reply;
            document.getElementById('reply-input').value = "";
            handleExtract();
        }

        async function handleAddToCalendar() {
            if (!isLoggedIn) { alert("Please login first!"); return; }
            const btn = document.getElementById('add-calendar-btn');
            const output = document.getElementById('result-output');
            btn.disabled = true; output.innerHTML = "";

            const payload = {
                summary: document.getElementById('summary-box').value,
                start_date: document.getElementById('start-date-box').value,
                end_date: document.getElementById('end-date-box').value,
                time: document.getElementById('time-box').value,
                location: document.getElementById('loc-box').value,
                is_allday: document.getElementById('allday-check').checked,
                description: "Added via AI Scheduler",
                original_text: originalText,
                translated_text: "",
                consent: document.getElementById('data-consent').checked
            };

            try {
                const res = await fetch('/add-to-calendar', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if(res.ok) output.innerHTML = `‚úÖ Success! <a href="${data.link}" target="_blank">View</a>`;
                else output.innerHTML = `‚ùå Error: ${data.error}`;
            } catch(e) { output.innerHTML = `‚ùå Error: ${e}`; }
            finally { btn.disabled = false; }
        }

        setLanguage('en');
    </script>
</body>
</html>