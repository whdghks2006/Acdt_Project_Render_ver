<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Smart Scheduler</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0 auto; max-width: 800px; padding: 20px; background-color: #f9fafb; }
        .container { background-color: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); position: relative; }
        h1, h2 { color: #111827; }
        label { display: block; margin-top: 15px; font-weight: 600; color: #374151; }
        textarea, input[type="text"] { width: 98%; padding: 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 1rem; margin-top: 5px; }

        button { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; margin-top: 20px; }
        .btn-secondary { background-color: #e5e7eb; color: #1f2937; }
        .btn-primary { background-color: #2563eb; color: white; font-weight: 600; }
        .btn-google { background-color: #DB4437; color: white; font-weight: bold; float: right; text-decoration: none; padding: 10px 15px; border-radius: 5px; font-size: 0.9rem; }

        #translated-output { background-color: #f3f4f6; border: none; }
        hr { border: none; border-top: 1px solid #e5e7eb; margin: 25px 0; }
        .loading { display: none; text-align: center; font-size: 1.2rem; color: #374151; margin-top: 10px;}
        #user-status { float: right; font-size: 0.9rem; color: #374151; margin-top: 10px; margin-right: 10px; }
        .consent-box { margin-top: 20px; padding: 10px; background-color: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 5px; }
        .tip-text { font-size: 0.85rem; color: #666; margin-top: 5px; }

        .map-buttons { margin-top: 5px; margin-bottom: 15px; display: flex; gap: 10px; }
        .btn-map { flex: 1; padding: 8px; font-size: 0.85rem; border-radius: 5px; text-decoration: none; text-align: center; color: white; font-weight: bold; transition: opacity 0.2s; }
        .btn-map:hover { opacity: 0.8; }
        .map-google { background-color: #4285F4; }
        .map-naver { background-color: #03C75A; }
        .map-kakao { background-color: #FAE100; color: #3C1E1E; }
        .hidden { display: none; }

        .lang-switch { position: absolute; top: 20px; left: 25px; font-size: 0.9rem; }
        .lang-btn { background: none; border: none; cursor: pointer; color: #666; font-weight: bold; padding: 0; }
        .lang-btn.active { color: #2563eb; text-decoration: underline; }
        .lang-divider { color: #ddd; margin: 0 5px; }

        .ai-msg-box { background-color: #e0f2fe; border: 1px solid #7dd3fc; color: #0c4a6e; padding: 15px; border-radius: 10px; margin-top: 10px; display: none; }
        .ai-reply-container { display: flex; margin-top: 10px; gap: 5px; }
        .ai-reply-input { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 5px; }
        .ai-reply-btn { background-color: #0284c7; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 0; }
    </style>
</head>
<body>

    <div class="container">
        <div class="lang-switch">
            <button onclick="setLanguage('ko')" class="lang-btn active" id="btn-ko">í•œêµ­ì–´</button>
            <span class="lang-divider">|</span>
            <button onclick="setLanguage('en')" class="lang-btn" id="btn-en">English</button>
        </div>

        <div id="login-area"><a href="/login" class="btn-google" id="txt-login">ğŸ“… Login with Google</a></div>
        <div id="user-status"></div>
        <div style="clear: both;"></div>

        <h1 id="txt-title" style="margin-top: 40px;">AI Smart Scheduler ğŸ“…</h1>
        <p id="txt-subtitle">Type a schedule. We use AI to extract details!</p>

        <h2 id="txt-step1">Step 1: Input & Translate</h2>

        <label for="input-text" id="lbl-input">ğŸ“ Input Text</label>
        <textarea id="input-text" rows="5" placeholder="ì˜ˆ: 'ë‚´ì¼ ì˜¤í›„ 7ì‹œì— í™ëŒ€ì…êµ¬ì—­ì—ì„œ íšŒì‹'"></textarea>

        <div id="ai-message" class="ai-msg-box">
            <span id="ai-text"></span>
            <div class="ai-reply-container">
                <input type="text" id="ai-user-reply" class="ai-reply-input" placeholder="Missing info...">
                <button onclick="handleAiReply()" class="ai-reply-btn" id="btn-reply">Send</button>
            </div>
        </div>

        <p class="tip-text" id="txt-tip">ğŸ’¡ Tip: AI might miss details. Check the <b>Translation</b> or edit manually in <b>Step 2</b>!</p>

        <button id="extract-button" class="btn-secondary" onclick="handleExtract()">1. Translate & Extract</button>

        <label for="translated-output" id="lbl-result">Result (Google Translated)</label>
        <textarea id="translated-output" rows="2" readonly></textarea>

        <hr>

        <h2 id="txt-step2">âœï¸ Step 2: Review & Add to Calendar</h2>
        <label id="lbl-date">ğŸ“… Date</label> <input type="text" id="date-box">
        <label id="lbl-time">â° Time</label> <input type="text" id="time-box">

        <label id="lbl-loc">ğŸ“ Location</label>
        <input type="text" id="loc-box" oninput="updateMapLinks()">

        <div id="map-links" class="map-buttons hidden">
            <a id="link-google" href="#" target="_blank" class="btn-map map-google">Google Maps</a>
            <a id="link-naver" href="#" target="_blank" class="btn-map map-naver">Naver Map</a>
            <a id="link-kakao" href="#" target="_blank" class="btn-map map-kakao">Kakao Map</a>
        </div>

        <label id="lbl-event">ğŸ‰ Event</label> <input type="text" id="event-box">

        <div class="consent-box">
            <input type="checkbox" id="data-consent" checked>
            <label for="data-consent" id="lbl-consent">(Optional) I agree to donate data for AI training.</label>
        </div>

        <button id="add-calendar-btn" class="btn-primary" onclick="handleAddToCalendar()">ğŸ“… Add to Google Calendar</button>
        <div class="loading" id="loading-spinner">ğŸ”„ Processing...</div>
        <div id="result-output" style="margin-top: 20px; font-weight: bold;"></div>
    </div>

    <script>
        let originalText = "";
        let translatedText = "";
        let isLoggedIn = false;

        const translations = {
            ko: {
                title: "AI ìŠ¤ë§ˆíŠ¸ ìŠ¤ì¼€ì¤„ëŸ¬ ğŸ“…",
                subtitle: "í•œê¸€ì´ë‚˜ ì˜ì–´ë¡œ ì¼ì •ì„ ì…ë ¥í•˜ì„¸ìš”. AIê°€ ìë™ìœ¼ë¡œ ì •ë¦¬í•´ì¤ë‹ˆë‹¤!",
                step1: "1ë‹¨ê³„: ì…ë ¥ ë° ë²ˆì—­",
                lblInput: "ğŸ“ ì…ë ¥ (í…ìŠ¤íŠ¸)",
                placeholder: "ì˜ˆ: 'ë‚´ì¼ ì˜¤í›„ 7ì‹œì— í™ëŒ€ì…êµ¬ì—­ì—ì„œ íšŒì‹'",
                tip: "ğŸ’¡ íŒ: ê²°ê³¼ê°€ ì´ìƒí•˜ë©´ <b>ë²ˆì—­ë¬¸</b>ì„ í™•ì¸í•˜ê±°ë‚˜ <b>2ë‹¨ê³„</b>ì—ì„œ ì§ì ‘ ìˆ˜ì •í•´ ì£¼ì„¸ìš”!",
                btnExtract: "1. ë²ˆì—­ ë° ì¶”ì¶œí•˜ê¸°",
                lblResult: "ê²°ê³¼ (ì˜ì–´ ë²ˆì—­)",
                step2: "âœï¸ 2ë‹¨ê³„: ê²€í†  ë° ìº˜ë¦°ë” ë“±ë¡",
                lblDate: "ğŸ“… ë‚ ì§œ",
                lblTime: "â° ì‹œê°„",
                lblLoc: "ğŸ“ ì¥ì†Œ",
                lblEvent: "ğŸ‰ ì¼ì • ì œëª©",
                lblConsent: "(ì„ íƒ) AI í•™ìŠµì„ ìœ„í•´ ë°ì´í„°ë¥¼ ê¸°ë¶€í•˜ëŠ” ê²ƒì— ë™ì˜í•©ë‹ˆë‹¤.",
                btnAdd: "ğŸ“… êµ¬ê¸€ ìº˜ë¦°ë”ì— ë“±ë¡í•˜ê¸°",
                login: "ğŸ“… êµ¬ê¸€ ë¡œê·¸ì¸",
                processing: "ğŸ”„ ì²˜ë¦¬ ì¤‘...",
                mapGoogle: "êµ¬ê¸€ ì§€ë„",
                mapNaver: "ë„¤ì´ë²„ ì§€ë„",
                mapKakao: "ì¹´ì¹´ì˜¤ë§µ",
                replyPlaceholder: "ë¹ ì§„ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”...",
                btnReply: "ì¶”ê°€"
            },
            en: {
                title: "AI Smart Scheduler ğŸ“…",
                subtitle: "Type a schedule in Korean or English. We use AI to extract details!",
                step1: "Step 1: Input & Translate",
                lblInput: "ğŸ“ Input Text",
                placeholder: "Ex: 'Dinner at Hongdae station at 7pm tomorrow'",
                tip: "ğŸ’¡ Tip: Check the <b>Translation</b> or edit manually in <b>Step 2</b>!",
                btnExtract: "1. Translate & Extract",
                lblResult: "Result (Google Translated)",
                step2: "âœï¸ Step 2: Review & Add to Calendar",
                lblDate: "ğŸ“… Date",
                lblTime: "â° Time",
                lblLoc: "ğŸ“ Location",
                lblEvent: "ğŸ‰ Event",
                lblConsent: "(Optional) I agree to donate data for AI training.",
                btnAdd: "ğŸ“… Add to Google Calendar",
                login: "ğŸ“… Login with Google",
                processing: "ğŸ”„ Processing...",
                mapGoogle: "Google Maps",
                mapNaver: "Naver Map",
                mapKakao: "Kakao Map",
                replyPlaceholder: "Type missing info...",
                btnReply: "Send"
            }
        };

        let currentLang = 'en';

        function setLanguage(lang) {
            currentLang = lang;
            const t = translations[lang];
            document.getElementById('txt-title').innerText = t.title;
            document.getElementById('txt-subtitle').innerText = t.subtitle;
            document.getElementById('txt-step1').innerText = t.step1;
            document.getElementById('lbl-input').innerText = t.lblInput;
            document.getElementById('input-text').placeholder = t.placeholder;
            document.getElementById('txt-tip').innerHTML = t.tip;
            document.getElementById('extract-button').innerText = t.btnExtract;
            document.getElementById('lbl-result').innerText = t.lblResult;
            document.getElementById('txt-step2').innerText = t.step2;
            document.getElementById('lbl-date').innerText = t.lblDate;
            document.getElementById('lbl-time').innerText = t.lblTime;
            document.getElementById('lbl-loc').innerText = t.lblLoc;
            document.getElementById('lbl-event').innerText = t.lblEvent;
            document.getElementById('lbl-consent').innerText = t.lblConsent;
            document.getElementById('add-calendar-btn').innerText = t.btnAdd;
            document.getElementById('txt-login').innerText = t.login;
            document.getElementById('link-google').innerText = t.mapGoogle;
            document.getElementById('link-naver').innerText = t.mapNaver;
            document.getElementById('link-kakao').innerText = t.mapKakao;
            document.getElementById('ai-user-reply').placeholder = t.replyPlaceholder;
            document.getElementById('btn-reply').innerText = t.btnReply;

            if (lang === 'ko') {
                document.getElementById('btn-ko').classList.add('active');
                document.getElementById('btn-en').classList.remove('active');
            } else {
                document.getElementById('btn-ko').classList.remove('active');
                document.getElementById('btn-en').classList.add('active');
            }
        }

        checkLogin();

        async function checkLogin() {
            try {
                const res = await fetch('/user-info');
                const data = await res.json();
                const loginArea = document.getElementById('login-area');
                const userStatus = document.getElementById('user-status');
                if (data.user) {
                    isLoggedIn = true;
                    loginArea.innerHTML = `<a href="/logout" class="btn-secondary" style="font-size:0.9rem; text-decoration:none;">Logout</a>`;
                    userStatus.innerText = `Welcome, ${data.user.name}`;
                } else { isLoggedIn = false; }
            } catch (e) { console.error(e); }
        }

        function updateMapLinks() {
            const loc = document.getElementById('loc-box').value.trim();
            const mapContainer = document.getElementById('map-links');
            if (!loc) { mapContainer.classList.add('hidden'); return; }
            mapContainer.classList.remove('hidden');
            document.getElementById('link-google').href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc)}`;
            document.getElementById('link-naver').href = `https://map.naver.com/v5/search/${encodeURIComponent(loc)}`;
            document.getElementById('link-kakao').href = `https://map.kakao.com/link/search/${encodeURIComponent(loc)}`;
        }

        async function handleExtract() {
            const inputText = document.getElementById('input-text').value;
            const btn = document.getElementById('extract-button');
            const aiMsgBox = document.getElementById('ai-message');
            const originalBtnText = btn.innerText;

            btn.innerText = translations[currentLang].processing;
            btn.disabled = true;
            aiMsgBox.style.display = 'none';

            try {
                const response = await fetch('/extract', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        text: inputText,
                        lang: currentLang
                    })
                });
                const data = await response.json();
                originalText = data.original_text;
                translatedText = data.translated_text;

                document.getElementById('translated-output').value = data.translated_text;
                document.getElementById('date-box').value = data.date;
                document.getElementById('time-box').value = data.time;
                document.getElementById('event-box').value = data.original_text;
                document.getElementById('loc-box').value = data.loc;
                updateMapLinks();

                if (data.ai_message) {
                    document.getElementById('ai-text').innerText = "ğŸ¤– AI: " + data.ai_message;
                    aiMsgBox.style.display = 'block';
                }

            } catch (error) { alert('Error processing text.'); }
            finally { btn.innerText = originalBtnText; btn.disabled = false; }
        }

        function handleAiReply() {
            const reply = document.getElementById('ai-user-reply').value.trim();
            if (!reply) return;
            const inputField = document.getElementById('input-text');
            inputField.value = inputField.value + " " + reply;
            document.getElementById('ai-user-reply').value = "";
            handleExtract();
        }

        async function handleAddToCalendar() {
            if (!isLoggedIn) { alert("Please login with Google first!"); return; }

            const btn = document.getElementById('add-calendar-btn');
            const spinner = document.getElementById('loading-spinner');
            const output = document.getElementById('result-output');
            const consent = document.getElementById('data-consent').checked;

            btn.disabled = true; spinner.style.display = 'block'; output.innerHTML = "";

            const eventData = {
                date_str: document.getElementById('date-box').value,
                time_str: document.getElementById('time-box').value,
                loc_str: document.getElementById('loc-box').value,
                event_str: document.getElementById('event-box').value,
                description: `Original: ${originalText}\nTranslated: ${translatedText}`,
                original_text: originalText,
                translated_text: translatedText,
                consent: consent
            };

            try {
                const response = await fetch('/add-to-calendar', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(eventData)
                });
                const data = await response.json();
                if (response.ok) {
                    output.innerHTML = `âœ… Added Successfully! <a href="${data.link}" target="_blank">View on Calendar</a><br><small>${data.saved_msg}</small>`;
                } else { output.innerHTML = `âŒ Error: ${data.error}`; }
            } catch (error) { output.innerHTML = `âŒ Error: ${error}`; }
            finally { btn.disabled = false; spinner.style.display = 'none'; }
        }

        setLanguage('en');
    </script>
</body>
</html>