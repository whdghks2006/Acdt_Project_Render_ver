<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Smart Scheduler</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0 auto; max-width: 800px; padding: 20px; background-color: #f9fafb; }
        .container { background-color: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        h1, h2 { color: #111827; }
        label { display: block; margin-top: 15px; font-weight: 600; color: #374151; }
        textarea, input[type="text"] { width: 98%; padding: 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 1rem; margin-top: 5px; }
        button { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; margin-top: 20px; }
        .btn-secondary { background-color: #e5e7eb; color: #1f2937; }
        .btn-primary { background-color: #2563eb; color: white; font-weight: 600; }
        .btn-google { background-color: #DB4437; color: white; font-weight: bold; float: right; text-decoration: none; padding: 10px 15px; border-radius: 5px; font-size: 0.9rem; }
        #translated-output { background-color: #f3f4f6; border: none; }
        hr { border: none; border-top: 1px solid #e5e7eb; margin: 25px 0; }
        .loading { display: none; text-align: center; font-size: 1.2rem; color: #374151; margin-top: 10px;}
        #user-status { float: right; font-size: 0.9rem; color: #374151; margin-top: 10px; margin-right: 10px; }
    </style>
</head>
<body>

    <div class="container">
        <div id="login-area">
            <a href="/login" class="btn-google">üìÖ Login with Google</a>
        </div>
        <div id="user-status"></div>
        <div style="clear: both;"></div>

        <h1>AI Smart Schedule Extractor ü§ñ</h1>
        <p>Supports both Korean (auto-translate) and English inputs.</p>

        <h2>Step 1: Input & Translate</h2>
        <label for="input-text">üìù Input Text</label>
        <textarea id="input-text" rows="5" placeholder="Ïòà: 'ÎÇ¥Ïùº Ïò§ÌõÑ 2ÏãúÏóê Í∞ïÎÇ®Ïó≠ÏóêÏÑú ÌöåÏùòÌïòÏûê'"></textarea>
        <button id="extract-button" class="btn-secondary" onclick="handleExtract()">1. Translate & Extract</button>

        <label for="translated-output">Result (Translated)</label>
        <textarea id="translated-output" rows="2" readonly></textarea>

        <hr>

        <h2>‚úèÔ∏è Step 2: Review & Add to Calendar</h2>
        <label>üìÖ Date</label> <input type="text" id="date-box">
        <label>‚è∞ Time</label> <input type="text" id="time-box">
        <label>üìç Location</label> <input type="text" id="loc-box">
        <label>üéâ Event</label> <input type="text" id="event-box">

        <button id="add-calendar-btn" class="btn-primary" onclick="handleAddToCalendar()">üìÖ Add to Google Calendar (Direct)</button>
        <div class="loading" id="loading-spinner">üîÑ Processing...</div>
        <div id="result-output" style="margin-top: 20px; font-weight: bold;"></div>
    </div>

    <script>
        let originalText = "";
        let translatedText = "";
        let isLoggedIn = false;

        // Check login status on load
        checkLogin();

        async function checkLogin() {
            try {
                const res = await fetch('/user-info');
                const data = await res.json();
                const loginArea = document.getElementById('login-area');
                const userStatus = document.getElementById('user-status');

                if (data.user) {
                    isLoggedIn = true;
                    loginArea.innerHTML = `<a href="/logout" class="btn-secondary" style="font-size:0.9rem; text-decoration:none;">Logout</a>`;
                    userStatus.innerText = `Welcome, ${data.user.name}`;
                } else {
                    isLoggedIn = false;
                }
            } catch (e) { console.error(e); }
        }

        async function handleExtract() {
            const inputText = document.getElementById('input-text').value;
            const btn = document.getElementById('extract-button');
            btn.innerText = "üîÑ Processing..."; btn.disabled = true;

            try {
                const response = await fetch('/extract', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ text: inputText })
                });
                const data = await response.json();
                originalText = data.original_text;
                translatedText = data.translated_text;

                document.getElementById('translated-output').value = data.translated_text;
                document.getElementById('date-box').value = data.date;
                document.getElementById('time-box').value = data.time;
                document.getElementById('loc-box').value = data.loc;
                document.getElementById('event-box').value = data.event;
            } catch (error) { alert('Error processing text.'); }
            finally { btn.innerText = "1. Translate & Extract"; btn.disabled = false; }
        }

        async function handleAddToCalendar() {
            if (!isLoggedIn) {
                alert("Please login with Google first!");
                return;
            }

            const btn = document.getElementById('add-calendar-btn');
            const spinner = document.getElementById('loading-spinner');
            const output = document.getElementById('result-output');

            btn.disabled = true; spinner.style.display = 'block'; output.innerHTML = "";

            const eventData = {
                date_str: document.getElementById('date-box').value,
                time_str: document.getElementById('time-box').value,
                loc_str: document.getElementById('loc-box').value,
                event_str: document.getElementById('event-box').value,
                description: `Original: ${originalText}\nTranslated: ${translatedText}`
            };

            try {
                const response = await fetch('/add-to-calendar', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(eventData)
                });
                const data = await response.json();

                if (response.ok) {
                    output.innerHTML = `‚úÖ Added Successfully! <a href="${data.link}" target="_blank">View on Calendar</a>`;
                } else {
                    output.innerHTML = `‚ùå Error: ${data.error}`;
                }
            } catch (error) { output.innerHTML = `‚ùå Error: ${error}`; }
            finally { btn.disabled = false; spinner.style.display = 'none'; }
        }
    </script>
</body>
</html>