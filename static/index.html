<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Smart Scheduler</title>
    <style>
        /* Basic Styles */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0 auto; max-width: 800px; padding: 20px; background-color: #f9fafb; }
        .container { background-color: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        h1, h2 { color: #111827; }
        label { display: block; margin-top: 15px; font-weight: 600; color: #374151; }
        textarea, input[type="text"] { width: 98%; padding: 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 1rem; margin-top: 5px; }

        /* Buttons */
        button { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; margin-top: 20px; }
        .btn-secondary { background-color: #e5e7eb; color: #1f2937; }
        .btn-primary { background-color: #2563eb; color: white; font-weight: 600; }
        .btn-google { background-color: #DB4437; color: white; font-weight: bold; float: right; text-decoration: none; padding: 10px 15px; border-radius: 5px; font-size: 0.9rem; }

        /* Outputs & Helpers */
        #translated-output { background-color: #f3f4f6; border: none; }
        hr { border: none; border-top: 1px solid #e5e7eb; margin: 25px 0; }
        .loading { display: none; text-align: center; font-size: 1.2rem; color: #374151; margin-top: 10px;}
        #user-status { float: right; font-size: 0.9rem; color: #374151; margin-top: 10px; margin-right: 10px; }
        .consent-box { margin-top: 20px; padding: 10px; background-color: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 5px; }
        .tip-text { font-size: 0.85rem; color: #666; margin-top: 5px; }

        /* [New] Map Button Styles */
        .map-buttons { margin-top: 5px; margin-bottom: 15px; display: flex; gap: 10px; }
        .btn-map {
            flex: 1; padding: 8px; font-size: 0.85rem; border-radius: 5px;
            text-decoration: none; text-align: center; color: white; font-weight: bold;
            transition: opacity 0.2s;
        }
        .btn-map:hover { opacity: 0.8; }
        .map-google { background-color: #4285F4; }
        .map-naver { background-color: #03C75A; }
        .map-kakao { background-color: #FAE100; color: #3C1E1E; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="container">
        <div id="login-area"><a href="/login" class="btn-google">ğŸ“… Login with Google</a></div>
        <div id="user-status"></div>
        <div style="clear: both;"></div>

        <h1>AI Smart Scheduler ğŸ“…</h1>
        <p>Type a schedule in Korean or English. We use AI to extract details!</p>

        <h2>Step 1: Input & Translate</h2>
        <label for="input-text">ğŸ“ Input Text</label>
        <textarea id="input-text" rows="5" placeholder="ì˜ˆ: 'ë‚´ì¼ ì˜¤í›„ 7ì‹œì— í™ëŒ€ì…êµ¬ì—­ì—ì„œ íšŒì‹'"></textarea>
        <p class="tip-text">ğŸ’¡ Tip: AIê°€ í•œêµ­ì–´ë¥¼ ë†“ì¹  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê²°ê³¼ê°€ ì´ìƒí•˜ë©´ <b>ë²ˆì—­ë¬¸(Translated)</b>ì„ ì°¸ê³ í•˜ê±°ë‚˜ <b>Step 2</b>ì—ì„œ ì§ì ‘ ìˆ˜ì •í•´ ì£¼ì„¸ìš”!</p>

        <button id="extract-button" class="btn-secondary" onclick="handleExtract()">1. Translate & Extract</button>

        <label for="translated-output">Result (Google Translated)</label>
        <textarea id="translated-output" rows="2" readonly></textarea>

        <hr>

        <h2>âœï¸ Step 2: Review & Add to Calendar</h2>
        <label>ğŸ“… Date</label> <input type="text" id="date-box">
        <label>â° Time</label> <input type="text" id="time-box">

        <label>ğŸ“ Location</label>
        <input type="text" id="loc-box" oninput="updateMapLinks()">

        <div id="map-links" class="map-buttons hidden">
            <a id="link-google" href="#" target="_blank" class="btn-map map-google">Google Maps</a>
            <a id="link-naver" href="#" target="_blank" class="btn-map map-naver">Naver Map</a>
            <a id="link-kakao" href="#" target="_blank" class="btn-map map-kakao">Kakao Map</a>
        </div>

        <label>ğŸ‰ Event</label> <input type="text" id="event-box">

        <div class="consent-box">
            <input type="checkbox" id="data-consent" checked>
            <label for="data-consent">(Optional) I agree to donate data for AI training.</label>
        </div>

        <button id="add-calendar-btn" class="btn-primary" onclick="handleAddToCalendar()">ğŸ“… Add to Google Calendar</button>
        <div class="loading" id="loading-spinner">ğŸ”„ Processing...</div>
        <div id="result-output" style="margin-top: 20px; font-weight: bold;"></div>
    </div>

    <script>
        let originalText = "";
        let translatedText = "";
        let isLoggedIn = false;

        checkLogin();

        async function checkLogin() {
            try {
                const res = await fetch('/user-info');
                const data = await res.json();
                const loginArea = document.getElementById('login-area');
                const userStatus = document.getElementById('user-status');
                if (data.user) {
                    isLoggedIn = true;
                    loginArea.innerHTML = `<a href="/logout" class="btn-secondary" style="font-size:0.9rem; text-decoration:none;">Logout</a>`;
                    userStatus.innerText = `Welcome, ${data.user.name}`;
                } else { isLoggedIn = false; }
            } catch (e) { console.error(e); }
        }

        // [New] Function to update map links
        function updateMapLinks() {
            const loc = document.getElementById('loc-box').value.trim();
            const mapContainer = document.getElementById('map-links');

            if (!loc) {
                mapContainer.classList.add('hidden');
                return;
            }

            mapContainer.classList.remove('hidden');

            // Update hrefs for each map service
            document.getElementById('link-google').href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc)}`;
            document.getElementById('link-naver').href = `https://map.naver.com/v5/search/${encodeURIComponent(loc)}`;
            document.getElementById('link-kakao').href = `https://map.kakao.com/link/search/${encodeURIComponent(loc)}`;
        }

        async function handleExtract() {
            const inputText = document.getElementById('input-text').value;
            const btn = document.getElementById('extract-button');
            btn.innerText = "ğŸ”„ Processing..."; btn.disabled = true;

            try {
                const response = await fetch('/extract', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ text: inputText })
                });
                const data = await response.json();
                originalText = data.original_text;
                translatedText = data.translated_text;

                document.getElementById('translated-output').value = data.translated_text;
                document.getElementById('date-box').value = data.date;
                document.getElementById('time-box').value = data.time;

                document.getElementById('event-box').value = data.original_text;

                // Update Location and Map Links
                document.getElementById('loc-box').value = data.loc;
                updateMapLinks(); // <--- Trigger map update

            } catch (error) { alert('Error processing text.'); }
            finally { btn.innerText = "1. Translate & Extract"; btn.disabled = false; }
        }

        async function handleAddToCalendar() {
            if (!isLoggedIn) { alert("Please login with Google first!"); return; }

            const btn = document.getElementById('add-calendar-btn');
            const spinner = document.getElementById('loading-spinner');
            const output = document.getElementById('result-output');
            const consent = document.getElementById('data-consent').checked;

            btn.disabled = true; spinner.style.display = 'block'; output.innerHTML = "";

            const eventData = {
                date_str: document.getElementById('date-box').value,
                time_str: document.getElementById('time-box').value,
                loc_str: document.getElementById('loc-box').value,
                event_str: document.getElementById('event-box').value,
                description: `Original: ${originalText}\nTranslated: ${translatedText}`,
                original_text: originalText,
                translated_text: translatedText,
                consent: consent
            };

            try {
                const response = await fetch('/add-to-calendar', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(eventData)
                });
                const data = await response.json();
                if (response.ok) {
                    output.innerHTML = `âœ… Added Successfully! <a href="${data.link}" target="_blank">View on Calendar</a><br><small>${data.saved_msg}</small>`;
                } else { output.innerHTML = `âŒ Error: ${data.error}`; }
            } catch (error) { output.innerHTML = `âŒ Error: ${error}`; }
            finally { btn.disabled = false; spinner.style.display = 'none'; }
        }
    </script>
</body>
</html>